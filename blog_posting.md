# FastAPI와 Celery로 구현하는 게임 서버용 FSM(Finite State Machine) 처리 시스템

안녕하세요! 오늘은 게임 서버에서 자주 사용되는 상태 기반 로직을 효율적으로 처리하기 위한 FSM(Finite State Machine) 처리 시스템을 소개하려고 합니다.

## 🎮 프로젝트 소개

게임 서버를 개발하다 보면 퀘스트, 매칭, 보상, 유닛 생성 등 다양한 상태 기반 로직을 처리해야 합니다. 이러한 상태 관리를 중앙 집중식으로 처리하고 로깅까지 담당하는 독립적인 백엔드 서버를 만들어보았습니다.

### 주요 기능

- 상태 전이 API (FSM 상태 변경)
- 상태 조회 API
- 비동기 로깅 시스템
- JSON 기반 FSM 정의
- 실시간 모니터링

## 🛠 기술 스택

- **FastAPI**: 비동기 API 서버
- **Redis**: 상태 저장소 및 메시지 브로커
- **Celery**: 비동기 작업 처리
- **Flower**: 작업 모니터링
- **Docker Compose**: 컨테이너 관리

## 💡 아키텍처 특징

1. **비동기 처리**

   - FastAPI의 비동기 처리로 높은 동시성 지원
   - Celery를 통한 비동기 로깅

2. **상태 관리**

   - Redis를 활용한 빠른 상태 저장/조회
   - JSON 기반의 유연한 FSM 정의

3. **모니터링**
   - Flower 대시보드로 실시간 작업 모니터링
   - 상태 전이 로그 추적

## 📝 사용 예시: 퀘스트 시스템

```json
{
  "name": "Quest FSM",
  "initial_state": "ready",
  "transitions": {
    "ready": {
      "start": "in_progress"
    },
    "in_progress": {
      "complete": "completed",
      "fail": "failed"
    },
    "failed": {
      "retry": "in_progress"
    },
    "completed": {}
  }
}
```

## 🚀 특징 및 장점

1. **확장성**

   - 새로운 FSM 타입을 JSON으로 쉽게 추가
   - 워커 스케일 아웃 가능

2. **안정성**

   - 상태 전이 실패 시 명확한 오류 응답
   - 워커 장애 시 자동 재시도

3. **개발 편의성**
   - 로컬 개발 환경 핫리로드 지원
   - Docker 기반 간편한 배포

## 🔍 활용 사례

- 퀘스트 진행 상태 관리
- 매칭 시스템 상태 관리
- 게임 세션 상태 관리
- 보상 지급 프로세스
- 유닛 생성/파괴 라이프사이클

## 📈 성능

- 동시에 여러 FSM 인스턴스 처리 가능
- Redis를 통한 빠른 상태 조회
- 비동기 처리로 응답 지연 최소화

## 🔧 설치 및 실행

```bash
# Redis 및 Celery 실행
docker-compose up --build

# FastAPI 서버 실행 (개발 모드)
uvicorn app.main:app --reload
```

## 마치며

이 프로젝트를 통해 게임 서버의 상태 관리를 더욱 체계적이고 효율적으로 할 수 있게 되었습니다. 특히 비동기 처리와 상태 관리의 중앙화를 통해 개발 생산성과 시스템 안정성을 크게 향상시킬 수 있었습니다.

전체 소스 코드는 GitHub에서 확인하실 수 있습니다. 게임 서버 개발에 도움이 되길 바랍니다! 😊
